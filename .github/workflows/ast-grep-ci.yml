name: Validate ast-grep Rules

on:
  pull_request:

jobs:
  validate-rules:
    runs-on: ubuntu-latest
    name: Validate ast-grep rules and tests

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            rules/**/*.yml
            rule-tests/**/*.yml

      - name: Install dependencies
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip

      - name: Download ast-grep binary for tests
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          curl -L -o ast-grep.zip https://github.com/ast-grep/ast-grep/releases/download/latest/app-x86_64-unknown-linux-gnu.zip
          unzip -o ast-grep.zip
          # Verify ast-grep binary works
          if [ -f "ast-grep" ]; then
            ./ast-grep --version || (echo "ast-grep binary not working"; exit 1)
            echo "$(pwd)" >> $GITHUB_PATH
          else
            echo "ast-grep binary not found after unzip"
            exit 1
          fi
          rm ast-grep.zip

      - name: Validate rules with ast-grep test
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Running ast-grep test framework..."
          ./ast-grep test --skip-snapshot-tests

      - name: Summary
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "## âœ… Rule Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All ast-grep rules and tests validated successfully using the test framework." >> $GITHUB_STEP_SUMMARY