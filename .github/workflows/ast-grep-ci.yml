name: Validate ast-grep Rules

on:
  pull_request:

jobs:
  validate-rules:
    runs-on: ubuntu-latest
    name: Validate ast-grep rules and tests

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            rules/**/*.yml
            rule-tests/**/*.yml

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          curl -fsSL https://raw.githubusercontent.com/ast-grep/ast-grep/main/scripts/install.sh | bash
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        if: steps.changed-files.outputs.any_changed == 'true'

      - name: Validate rules with ast-grep test
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Running ast-grep test framework..."
          ast-grep test --skip-snapshot-tests

      - name: Summary
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "## âœ… Rule Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All ast-grep rules and tests validated successfully using the test framework." >> $GITHUB_STEP_SUMMARY